<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <title>安装结算单</title>
    <link rel="stylesheet" href="common/css/example.css"/>
    <link rel="stylesheet" href="common/css/weui.css">
    <link type="text/css" rel="stylesheet" href="imgupload/index.css">
    <link rel="stylesheet" href="common/css/myweui.css">
</head>
<body>

<div class="page my-page">
    <div class="p-20">
        <h1 class="page__title">
            <img src="../img/logo.png" alt="弗立兹" height="36px"/>
        </h1>
        <h3 class="">安装结算单</h3>
        <p class="sc-color">此表单信息提供安装信息提交入口。</p>
    </div>

    <div class="page__bd">
        <div class="weui-cells__title">客户姓名</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <input id="name" class="weui-input mustInput" maxlength="8" type="text" placeholder="请输入客户姓名"/>
                    <div class="errortip">此项必填</div>
                </div>
            </div>
        </div>

        <div class="weui-cells__title">手机号</div>
        <div class="weui-cells">

            <div class="weui-cell weui-cell_select weui-cell_select-before">
                <div class="weui-cell__hd">
                    <select class="weui-select" name="select2">
                        <option value="1">+86</option>
                        <option value="2">+80</option>
                        <option value="3">+84</option>
                        <option value="4">+87</option>
                    </select>
                </div>
                <div class="weui-cell__bd">
                    <input id="phone" class="weui-input phone" type="number" maxlength="11" pattern="[0-9]*" placeholder="请输入手机号码"/>
                    <div class="errortip">请填写正确的手机号</div>
                </div>
            </div>
        </div>

        <div class="weui-cells__title">客户地址</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <input id="address" class="weui-input mustInput" type="text" maxlength="100" placeholder="请输入客户地址"/>
                    <div class="errortip">此项必填</div>
                </div>
            </div>
        </div>

        <div class="weui-cells__title">联系邮箱</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <input id="email" class="weui-input email" type="text" maxlength="50" placeholder="请输入联系邮箱"/>
                    <div class="errortip">请填入正确的邮箱地址</div>
                </div>
            </div>
        </div>

        <div class="weui-cells__title">合同附件</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <input id="fsrc" class="weui-input" type="text" placeholder="请上传合同附件"/>
                    <!--<div class="errortip">此项必填</div>-->
                </div>
            </div>
        </div>
        
        <div class="weui-cells__title">报价单电子版</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <input id="isrc" class="weui-input" type="text" placeholder="请上传报价单电子版"/>
                    <!--<div class="errortip">此项必填</div>-->
                </div>
            </div>
        </div>

        <div class="weui-cells__title">发货日期</div>
        <div class="weui-cells">
        <div class="weui-cell">
            <div class="weui-cell__hd"><label for="" class="weui-label">日期</label></div>
            <div class="weui-cell__bd">
                <input id="time" class="weui-input mustInput" type="date" value=""/>
                <div class="errortip">此项必填</div>
            </div>
        </div>
        </div>

        <div class="weui-cells__title">付款条件</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <input id="info" class="weui-input mustInput" type="text" maxlength="200" placeholder="请填写付款条件"/>
                    <div class="errortip">此项必填</div>
                </div>
            </div>
        </div>

        <div class="weui-cells__title">是否计量</div>
        <div class="weui-cells weui-cells_radio">
            <label class="weui-cell weui-check__label" for="x11">
                <div class="weui-cell__bd">
                    <p>需要计量</p>
                </div>
                <div class="weui-cell__ft">
                    <input type="radio" class="weui-check" name="radio1" id="x11" value="1"/>
                    <span class="weui-icon-checked"></span>
                </div>
            </label>
            <label class="weui-cell weui-check__label" for="x12">

                <div class="weui-cell__bd">
                    <p>不需要</p>
                </div>
                <div class="weui-cell__ft">
                    <input type="radio" name="radio1" class="weui-check" id="x12"  value="0" checked="checked"/>
                    <span class="weui-icon-checked"></span>
                </div>
            </label>
        </div>

        <div class="weui-cells__title">验收单</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <div class="img-box full">
                        <section class=" img-section">
                            <p class="up-p"><span class="up-span">最多可以上传5张图片</span></p>
                            <div class="z_photo upimg-div clear">
                                <section class="z_file fl">
                                    <img src="imgupload/a11.png" class="add-img">
                                    <input type="file" name="file" id="file" class="file" value="" accept="image/jpg,image/jpeg,image/png,image/bmp" multiple="">
                                </section>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>

        <div class="weui-cells__title">客户要求</div>
        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <textarea id="khyq" class="weui-textarea" rows="5" type="text" placeholder="请输入客户要求"></textarea>
                    <div class="errortip">此项必填</div>
                </div>
            </div>
        </div>

        <div class="weui-btn-area">
            <a class="weui-btn weui-btn_primary" href="javascript:" id="submit-btn">确定</a>
        </div>

        <div class="page__ft">
            <a href="javascript:void(0)" style="color:#666;font-size:12px;line-height:56px;"><img src="../img/logoicon.png"/>SSOSCH</a>
        </div>
    </div>
</div>

<div class="tip"></div>

    <script src="common/js/zepto.min.js"></script>
    <script type="text/javascript" src="common/js/jweixin-1.0.0.js"></script>
    <script src="common/js/weui.min.js"></script>
    <script src="imgupload/imgUp.js"></script>
    <script src="common/js/main.js"></script>

    <script type="text/javascript">
        $(function () {
            //页面跳转接收项目id值
            function GetQueryString(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return (r[2]);
                return null;
            }
            var uid = GetQueryString("uid");
            var pid = GetQueryString("pid");
            if(uid && pid){
                // console.log(uid,pid);

                $("#name,#phone,#address,#email,#fsrc,#isrc,#time,#info,#x11,#x12").attr('disabled', false);

                //获取默认数据
                var getOldData = {
                    "id" : pid,
                    "sctype" : 1
                };
                $.ajax({
                    type: "POST",  //提交方式
                    url: "controller/shengchan.php",//路径
                    data: getOldData,//数据，这里使用的是Json格式进行传输
                    dataType: "json",
                    beforeSend: function(xhr, settings){
                        $(".loading").show();
                    },
                    success: function (data) {//返回数据根据结果进行相应的处理
                        console.log(data);
                        if (data && data.length > 0) {
                            $("#name").val(data[0].fname);
                            $("#phone").val(data[0].fphone);
                            $("#address").val(data[0].faddress);
                            $("#email").val(data[0].femail);
                            $("#fsrc").val(data[0].ffsrc);
                            $("#isrc").val(data[0].fisrc);
                            $("#time").val(data[0].ftime);
                            $("#info").val(data[0].finfo);

                            if(data[0].fradio == 1 ){
                                $("#x11").attr('checked',true);
                            }
                        }
                    },
                    error: function (xhr, type) {
                        $('.tip').html("提交失败稍后再试").show();
                        setTimeout(function() {
                            $(".tip").hide(500);
                        }, 1000);
                    }
                });

                // 提交新数据
                $("#submit-btn").click(function () {
                    //图片地址处理
                    var imgsrcData = '';
                    $(".imgsrcs").each(function (e) {
                        imgsrcData += $(this).val()+',';
                    });
                    var modal_name = $("#name").val();
                    var modal_phone = $("#phone").val();
                    var modal_address = $("#address").val();
                    var modal_email = $("#email").val();
                    var modal_fsrc = $("#fsrc").val();
                    var modal_isrc = $("#isrc").val();
                    var modal_time = $("#time").val();
                    var modal_info = $("#info").val();
                    var modal_resultisrc = $("#resultisrc").val();
                    var modal_radio = $("input[name='radio1']:checked").val();
                    var modal_anzhuang = $("#userselect").val();
                    var modal_ysdsrc = imgsrcData;
                    var modal_khyq = $("#khyq").val();

                    var params = {
                        id: pid,
                        sctype: 3,
                        fname: modal_name,
                        fphone: modal_phone,
                        faddress: modal_address,
                        femail: modal_email,
                        ffsrc: modal_fsrc,
                        fisrc: modal_isrc,
                        ftime: modal_time,
                        finfo: modal_info,
                        fradio: modal_radio,
                        fresultisrc: modal_resultisrc,
                        fanzhuang: modal_anzhuang,
                        fysd: modal_ysdsrc,
                        fkhyq: modal_khyq
                    };
                    console.log(params);
                    $.ajax({
                        type: "POST",  //提交方式
                        url: "controller/shengchan.php",//路径
                        data: params,//数据，这里使用的是Json格式进行传输
                        dataType: "json",
                        beforeSend: function(xhr, settings){
                            $(".loading").show();
                        },
                        success: function (data) {//返回数据根据结果进行相应的处理
                            console.log(data);
                            if (data.result == '1') {
                                console.log('提交成功');
                            }
                            $('.tip').html(data.msg).show();
                            setTimeout(function() {
                                $(".tip").hide(500);
                            }, 1000);
                        },
                        error: function (xhr, type) {
                            $('.tip').html("提交失败稍后再试").show();
                            setTimeout(function() {
                                $(".tip").hide(500);
                            }, 1000);
                        }
                    });

                });
            }
        });

        var dataList = [];
        var anzhuangList = [];
        var caiwuList = [];
        //获取用户默认数据
        $.ajax({
            type: "POST",  //提交方式
            url: "controller/changeuser.php",//路径
            data: {sctype: 2},//数据，这里使用的是Json格式进行传输
            dataType: "json",
            beforeSend: function (xhr, settings) {
                // $(".loading").show();
            },
            success: function (data) {//返回数据根据结果进行相应的处理
                // console.log(data);
                dataList = data;
                if (data) {
                    for (var j = 0; j < data.length; j++) {
                        if (data[j].type == 5) {
                            anzhuangList.push(data[j]);
                        }
                    }
                    for (var i = 0; i < anzhuangList.length; i++) {
                        $("#userselect").append("<option value='" + anzhuangList[i].id + "'>" + anzhuangList[i].username + "</option>");
                    }
                }
            },
            error: function (xhr, type) {
                $('.tip').html("网络故障").show();
                setTimeout(function () {
                    $(".tip").hide(500);
                }, 1000);
            }
        });

        function selectfunc(){
            //获取被选中的option标签
            var vs = $('#userselect').val();
            var info = {};
            if(vs && dataList.length > 0){
                for (var i = 0; i < dataList.length; i++) {
                    if(vs == dataList[i].id){
                        info = dataList[i];
                    }
                }
                localStorage.setItem('key', JSON.stringify(info));
            }
            console.log(info);
            if(info.type == 3){
                window.location.href = "toshengchan.html";
            }else if(info.type == 4){
                window.location.href = "tokuaiji.html";
            }
        }
    </script>
</body>
</html>
